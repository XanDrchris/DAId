// Copyright (C)2023-present Xander Christopher(https://github.com/XandrChris).
// All rights reserved.

(()=>{async function a(){g.detect(v).then(b=>{for(let a=0;a<u.length;a++)w.removeChild(u[a]);u.splice(0);for(let a=0;a<b.length;a++){let c=document.createElement("div"),d=document.createElement("div");c.classList.add("objBor"),d.classList.add("objName"),d.style.cssText=`width:${b[a].bbox[2]-1}px;`,d.innerText=b[a].class+", "+(100*b[a].score).toFixed(0)+"%",c.style.cssText=`left:${b[a].bbox[0]}px;top:${b[a].bbox[1]}px;width:${b[a].bbox[2]}px;height:${b[a].bbox[3]}px;`,c.appendChild(d),w.appendChild(c),u.push(c)}l=x(a)})}function b(a){let b=a.parentNode;window.scrollTo(0,0),j=gsap.timeline({}),j.to(b,{position:"absolute",top:0,left:0,width:"100%",height:"100%",duration:.15}),j.to(a,{scale:3,zIndex:2,borderRadius:3,duration:.15},">")}function c(a){let b=a.parentNode,c=gsap.timeline({});c.to(a,{scale:1,zIndex:0,borderRadius:10,duration:.15}),c.to(b,{position:"relative",width:"auto",height:"auto",duration:.15})}async function d(){cocoSsd.load(i).then(a=>{g=a,q.classList.add("hidden"),document.body.style.overflow="auto"})}function e(a,b){g.detect(a,20,.2).then(c=>{q.classList.add("hidden"),f(a,c,b)})}function f(a,b,c){let d=1;"sample"===c&&(d=3);let e=document.createElement("div");e.style.cssText=`position:absolute;width:${a.width*d}px;height:${a.height*d}px;z-index:${d}`;for(let f=0;f<b.length;f++){const a=document.createElement("div"),c=document.createElement("div");c.classList.add("objName"),a.classList.add("objBor"),c.style.cssText=`width:${b[f].bbox[2]*d-1}px;`,c.innerText=b[f].class+", "+(100*b[f].score).toFixed(0)+"%",a.style.cssText=`left:${b[f].bbox[0]*d}px;top:${b[f].bbox[1]*d}px;width:${b[f].bbox[2]*d}px;height:${b[f].bbox[3]*d}px;`,a.appendChild(c),e.appendChild(a)}a.parentNode.appendChild(e)}let g,h,i,j,k,l,m=document.querySelector("#sampleImage"),n=document.querySelector("#openImageBtn"),o=document.querySelectorAll(".modelGridSec"),p=document.querySelector("#loadModel"),q=document.querySelector("#loaderDiv"),r=document.querySelectorAll(".imageCont"),s=document.querySelector("#backOpac"),t=document.querySelector("#webcamBtn"),u=[],v=document.querySelector("#webCamVideo"),w=document.querySelector("#webCamObjCont"),x=window.requestAnimationFrame||window.mozRequstAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;t.addEventListener("click",()=>{if(!g)window.alert("Load a model First!");else if("Disable Webcam"==t.innerHTML)k.forEach(a=>{a.stop()}),t.innerHTML="Enable Webcam",cancelAnimationFrame(l),v.srcObject=null,v.classList.add("hidden"),w.classList.add("hidden");else{let b=navigator.mediaDevices;b.getUserMedia({video:!0}).then(b=>{t.innerHTML="Disable Webcam",v.classList.remove("hidden"),w.classList.remove("hidden"),window.scrollTo(0,document.body.offsetHeight),v.srcObject=b,k=b.getTracks(),v.addEventListener("loadedmetadata",a)}).catch(alert)}}),p.addEventListener("click",()=>{o.forEach(a=>{a.children[0].checked&&(i={base:a.getAttribute("model")},d())}),window.scrollTo(0,0),q.classList.remove("hidden"),document.body.style.overflow="hidden",p.disabled=!0}),o.forEach(a=>{a.addEventListener("click",()=>{a.children[0].checked=!0,p.disabled=!1})}),r.forEach(a=>{a.addEventListener("click",()=>{"yes"==a.getAttribute("enable")&&(g?(b(a),a.setAttribute("enable","no"),s.classList.remove("hidden"),document.body.style.overflow="hidden",s.addEventListener("click",()=>{c(a),s.classList.add("hidden"),s.removeEventListener("click",s),a.parentNode.children[1].remove(),a.setAttribute("enable","yes"),document.body.style.overflow="auto"}),setTimeout(()=>{q.classList.remove("hidden"),e(a,"sample")},500)):window.alert("Load Model First!"))})});let y=(a,b="",c=512)=>{let d=a,e=[];for(let f=0;f<d.length;f+=c){let a=d.slice(f,f+c),b=Array(a.length);for(let c=0;c<a.length;c++)b[c]=a.charCodeAt(c);let g=new Uint8Array(b);e.push(g)}let f=new Blob(e,{type:b});return f};const z={types:[{description:"Images",accept:{"image/*":[".png",".jpg",".jpeg"]}}],excludeAcceptAllOption:!0,multiple:!1};n.addEventListener("click",async()=>{if(g){[h]=await window.showOpenFilePicker(z);const a=await h.getFile(),b=a.type,c=new FileReader;c.readAsDataURL(a),c.onload=a=>{let c=a.target.result.slice(a.target.result.indexOf(";")+8),d=atob(c),f=y(d,b),g=URL.createObjectURL(f);m.src=g,m.onload=()=>{m.parentNode.children[1]&&m.parentNode.children[1].remove(),setTimeout(()=>{e(m,"users")},1e3)}}}else window.alert("Load a model first!")})})();